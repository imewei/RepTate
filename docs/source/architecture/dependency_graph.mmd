```mermaid
graph TB
    %% RepTate Architecture Dependency Graph
    %% Generated: 2025-12-30

    %% External Dependencies
    subgraph External["External Libraries"]
        numpy["numpy â‰¥2.2.0"]
        jax["JAX â‰¥0.8.0"]
        nlsq["NLSQ â‰¥0.4.1"]
        pyside6["PySide6 â‰¥6.6.0"]
        matplotlib["matplotlib â‰¥3.9.0"]
        numpyro["NumPyro â‰¥0.14.0"]
    end

    %% Core Module
    subgraph Core["core/ - Foundation Layer"]
        cmdbase["CmdBase<br/>(CalcMode enum)"]
        param["Parameter<br/>(data model)"]
        view["View<br/>(view model)"]
        datatable["DataTable<br/>(âš ï¸ matplotlib!)"]
        file["File<br/>(data container)"]
        filetype["FileType<br/>(file readers)"]
        interfaces["interfaces.py<br/>(âœ… Protocols)"]
        serialization["serialization.py<br/>(âœ… Safe JSON+NPZ)"]
        safe_eval["safe_eval.py<br/>(âœ… Secure eval)"]
        multiview["MultiView<br/>(âŒ Qt in core!)"]
    end

    %% Fitting Module
    subgraph Fitting["core/fitting/ - Numerical Engine"]
        nlsq_fit["nlsq_fit.py"]
        nlsq_optimize["nlsq_optimize.py"]
        model_api["model_api.py"]
    end

    %% GUI Module
    subgraph GUI["gui/ - Presentation Layer"]
        qappmanager["QApplicationManager<br/>(main window)"]
        qappwindow["QApplicationWindow<br/>(app container)"]
        qdataset["QDataSet<br/>(dataset widget)"]
        qtheory["QTheory<br/>(âš ï¸ GOD CLASS!)"]
        qtool["QTool<br/>(tool widget)"]
    end

    %% Controllers (NEW - MVC pattern)
    subgraph Controllers["gui/controllers/ - Business Logic"]
        fit_controller["fit_controller.py<br/>(âœ… No Qt!)"]
        inference_controller["inference_controller.py<br/>(âœ… No Qt!)"]
        export_controller["export_controller.py"]
    end

    %% Views (NEW - MVC pattern)
    subgraph Views["gui/views/ - View Components"]
        summary_view["summary_view.py"]
        fit_view["fit_view.py"]
        inference_view["inference_view.py"]
        plot_views["plot_views.py"]
    end

    %% Theories Module
    subgraph Theories["theories/ - Scientific Models"]
        theory_basic["TheoryBasic<br/>(âŒ inherits QTheory!)"]
        maxwell["TheoryMaxwellModes"]
        roliepoly["TheoryRoliePoly<br/>(âœ… JAX ODE)"]
        bob["TheoryBobLVE<br/>(ctypes â†’ C)"]
        likhtman["TheoryLikhtmanMcLeish"]
    end

    %% Ctypes Helpers
    subgraph CTypes["theories/*_ctypes_helper - C Integration"]
        bob_helper["BobCtypesHelper"]
        react_helper["react_ctypes_helper"]
        rouse_helper["rouse_ctypes_helper"]
    end

    %% Applications Module
    subgraph Applications["applications/ - Orchestration"]
        app_lve["ApplicationLVE<br/>(âŒ 10 theory imports!)"]
        app_laos["ApplicationLAOS"]
        app_mwd["ApplicationMWD"]
    end

    %% Tools Module
    subgraph Tools["tools/ - Utilities"]
        tool_eval["ToolEvaluate<br/>(âœ… safe_eval)"]
        tool_db["ToolMaterialsDatabase"]
        tool_smooth["ToolSmooth<br/>(âœ… numpy, no scipy!)"]
    end

    %% ========================================
    %% DEPENDENCY EDGES
    %% ========================================

    %% External Dependencies
    numpy --> datatable
    numpy --> param
    numpy --> file
    numpy --> nlsq_fit

    jax --> nlsq_fit
    jax --> nlsq_optimize
    jax --> roliepoly
    jax --> safe_eval

    nlsq --> nlsq_fit

    pyside6 --> qappmanager
    pyside6 --> qappwindow
    pyside6 --> qdataset
    pyside6 --> qtheory
    pyside6 --> multiview

    matplotlib --> datatable
    matplotlib --> qappwindow

    numpyro --> qtheory

    %% Core Internal Dependencies
    datatable --> file
    file --> filetype
    cmdbase --> multiview
    param --> interfaces

    %% Fitting Dependencies
    nlsq_optimize --> nlsq_fit
    interfaces --> nlsq_fit
    param --> nlsq_fit

    %% GUI Dependencies
    qappmanager --> qappwindow
    qappmanager --> app_lve
    qappmanager --> app_laos
    qappmanager --> app_mwd

    qappwindow --> qdataset
    qappwindow --> qtheory
    qappwindow --> multiview
    qappwindow --> fit_controller
    qappwindow --> inference_controller
    qappwindow --> export_controller
    qappwindow --> fit_view
    qappwindow --> inference_view
    qappwindow --> plot_views

    qdataset --> datatable
    qdataset --> file
    qdataset --> qtheory

    qtheory --> param
    qtheory --> datatable
    qtheory --> nlsq_optimize
    qtheory --> fit_controller
    qtheory --> inference_controller

    %% Controllers Dependencies (âœ… Clean - no Qt!)
    fit_controller --> nlsq_fit
    fit_controller --> interfaces
    inference_controller --> numpyro
    inference_controller --> interfaces

    %% Theory Dependencies (âŒ CIRCULAR!)
    theory_basic -.->|inherits| qtheory
    maxwell -.->|inherits| qtheory
    roliepoly -.->|inherits| qtheory
    bob -.->|inherits| qtheory
    likhtman -.->|inherits| qtheory

    maxwell --> param
    roliepoly --> param
    bob --> param

    bob --> bob_helper
    react_helper --> CTypes
    rouse_helper --> CTypes

    %% Application Dependencies (âŒ DIRECT IMPORTS!)
    app_lve -.->|imports| maxwell
    app_lve -.->|imports| roliepoly
    app_lve -.->|imports| likhtman
    app_lve --> qappwindow
    app_laos --> qappwindow
    app_mwd --> qappwindow

    %% Tool Dependencies (âœ… Clean!)
    tool_eval --> safe_eval
    tool_smooth --> numpy

    %% ========================================
    %% STYLING
    %% ========================================

    classDef critical fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    classDef warning fill:#ffa94d,stroke:#fd7e14,stroke-width:2px
    classDef good fill:#51cf66,stroke:#2f9e44,stroke-width:2px
    classDef new fill:#74c0fc,stroke:#1971c2,stroke-width:2px

    class datatable,multiview,qtheory,theory_basic critical
    class qappwindow,qdataset,app_lve warning
    class interfaces,serialization,safe_eval,fit_controller,inference_controller,tool_smooth good
    class Controllers,Views,Fitting new

    %% Legend
    subgraph Legend
        L1["âŒ Critical Issues<br/>(circular deps, tight coupling)"]
        L2["âš ï¸ Needs Attention<br/>(moderate coupling)"]
        L3["âœ… Good Architecture<br/>(loose coupling)"]
        L4["ğŸ†• New Components<br/>(migration improvements)"]
    end

    class L1 critical
    class L2 warning
    class L3 good
    class L4 new
```

---

## Key Architectural Problems (Visual Guide)

### ğŸ”´ Critical Circular Dependency Cycles

```mermaid
graph LR
    A[gui/QTheory] -->|imports| B[theories/*]
    B -->|inherits from| A

    C[gui/QApplicationWindow] -->|imports| D[applications/*]
    D -->|imports| C

    E[core/DataTable] -->|creates| F[matplotlib.lines.Line2D]
    F -->|requires| E

    style A fill:#ff6b6b
    style B fill:#ff6b6b
    style C fill:#ffa94d
    style D fill:#ffa94d
    style E fill:#ff6b6b
    style F fill:#ff6b6b
```

### ğŸŸ¢ Target Architecture (After Migration)

```mermaid
graph TB
    subgraph "Business Logic Layer"
        theory[ITheory Protocol]
        calc[Pure JAX Calculations]
        data[DataTable - No Matplotlib]
    end

    subgraph "Presentation Layer"
        gui[QTheoryWidget]
        plot[PlotView]
    end

    subgraph "Orchestration Layer"
        controller[FitController]
        registry[TheoryRegistry]
    end

    theory --> calc
    calc --> data
    controller --> theory
    gui --> controller
    plot --> data
    registry -.->|lookup| theory

    style theory fill:#51cf66
    style calc fill:#51cf66
    style data fill:#51cf66
    style controller fill:#74c0fc
    style registry fill:#74c0fc
```

---

## Data Flow Architecture (Current vs. Target)

### ğŸ”´ Current: Tightly Coupled Data Flow

```mermaid
sequenceDiagram
    participant User
    participant QApplicationWindow
    participant DataTable
    participant QTheory
    participant Theory Logic
    participant Matplotlib

    User->>QApplicationWindow: Load File
    QApplicationWindow->>DataTable: Create with axes âŒ
    DataTable->>Matplotlib: Create Line2D objects âŒ

    User->>QTheory: Fit Data
    QTheory->>Theory Logic: Calculate (mixed with GUI) âŒ
    Theory Logic->>DataTable: Update data
    DataTable->>Matplotlib: Update Line2D âŒ
    Matplotlib-->>User: Render plot

    Note over DataTable,Matplotlib: âŒ Data coupled to visualization
    Note over QTheory,Theory Logic: âŒ Business logic in GUI class
```

### ğŸŸ¢ Target: Clean Separation

```mermaid
sequenceDiagram
    participant User
    participant View
    participant Controller
    participant ITheory
    participant DataModel
    participant Renderer

    User->>View: Load File
    View->>Controller: handle_load()
    Controller->>DataModel: Create DataTable âœ…
    Note over DataModel: No visualization objects

    User->>View: Fit Data
    View->>Controller: handle_fit()
    Controller->>ITheory: calculate(params, x) âœ…
    ITheory-->>Controller: JAX Array
    Controller->>DataModel: Update data
    Controller->>View: notify_change()
    View->>Renderer: plot(data_model) âœ…
    Renderer-->>User: Render plot

    Note over DataModel: âœ… Pure data
    Note over ITheory: âœ… Pure computation
    Note over Controller: âœ… Orchestration only
```

---

## Migration Priority Heatmap

| Module | Complexity | Coupling | Test Coverage | Priority |
|--------|-----------|----------|---------------|----------|
| **QTheory** | ğŸ”´ Very High | ğŸ”´ Very High | ğŸŸ¡ Medium | ğŸ”´ **CRITICAL** |
| **DataTable** | ğŸŸ¡ Medium | ğŸ”´ High | ğŸŸ¡ Medium | ğŸ”´ **CRITICAL** |
| **QApplicationWindow** | ğŸ”´ High | ğŸ”´ High | ğŸ”´ Low | ğŸ”´ **HIGH** |
| **Theories/** | ğŸŸ¡ Medium | ğŸ”´ High | ğŸŸ¢ High | ğŸŸ¡ **HIGH** |
| **Applications/** | ğŸŸ¢ Low | ğŸŸ¡ Medium | ğŸŸ¡ Medium | ğŸŸ¢ **MEDIUM** |
| **Controllers/** | ğŸŸ¢ Low | ğŸŸ¢ Low | ğŸ”´ Low | ğŸŸ¢ **LOW** (new) |

Legend:
- ğŸ”´ High Risk / Complexity
- ğŸŸ¡ Medium Risk / Complexity
- ğŸŸ¢ Low Risk / Complexity
